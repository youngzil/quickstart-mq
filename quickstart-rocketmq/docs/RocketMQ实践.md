RocketMQ实践.md

普通消息、顺序消息、延迟消息还是事务消息

即同一个 Group ID 下的所有机器，订阅的 Topic 和 Tag 必须完全一样

消费者线程源码

使用消息队列时可能碰到的问题
发送时失败
发送失败的解决方案
消息重复接收
消息消费到一半时机器异常宕机

消息丢失

---------------------------------------------------------------------------------------------------------------------


普通消息、顺序消息、延迟消息还是事务消息

即同一个 Group ID 下的所有机器，订阅的 Topic 和 Tag 必须完全一样
注意：
1. 不要设置错了 Group ID，这样会导致正确的 Group ID 出现消息不一致的情况 
2. Topic 或 Tag 不要随意的修改或删除 
3. 对应用的消息订阅信息做了修改时，在消息队列控制台中查看该应用的订阅关系是否一致


消费者线程源码：
1. 无界队列：建议在应用消费的地方做限流处理，防止出现 OOM
2. ConsumeThreadMin 默认为 20（同时也是最小值），可以根据机器和业务特性进行调整：

3. 使用消息队列时可能碰到的问题
3.1 发送时失败
如果发送的是异步消息类型，客户端不会做重试处理（即只会发送一次）
如果发送的是同步消息类型，默认会重试1次（即一共发送两次）
在实际观察发现，当消息发送失败时，基本上都是因为 Broker 集群抖动造成的

3.2 发送失败的解决方案
ons-client 封装将发送时的异常信息封装为 ONSClientException，因此我们可以捕获该异常，在 catch 代码块中，保存发送失败的消息，稍后发送。建议至少一分钟后再发送，因为在实际线上场景中发现，如果出现了 Broker 抖动，在一分钟内消息中间件都是不会接受消息的
具体实现可以使用 redis list lpush 存储，接着在 xxl-job 中使用 rpop 拉出一段时间内发送失败的消息进行重试发送 
注意：当发送失败的消息是精确的定时消息时，需要做额外处理以保证重试不会影响时间精度


3.2 消息重复接收
1、虽然 ONS 提供了 Exactly-Once 特性来保证消息的最终处理结果写入到数据库有且仅有一次。但是实际中，即使开启了该特性，仍然有极小概率出现重复写入，而且随着分布式机器的增加，几率也会增加（阿里云官方人员也证实确实会这样）。
2、虽然最佳方案是消息接收时让业务处理逻辑保证幂等性，但是业务各式各样，尤其是在复杂业务场景下，很难保证每个业务都具有幂等性。因此选择另一个和业务无关方案：通过 Redission 锁 + MessageKey 来保证同一个消息内容在某个时间段内仅会消费一次。
3、此方案强依赖 Redis，因此需要保证 Redis 集群的可用性。
4、具体实现：消息发送时，使用消息内容的 MD5 作为 MessageKey，由于 MD5 会出现不同内容极小概率得到相同的 MD5，因此额外加上 messageTag（也可以使用其它信息摘要算法）
5、消息接收时，通过 Redission 分布式锁对其 MessageKey 做锁处理（可以使用其它分布式锁）

3.3 消息消费到一半时机器异常宕机
1、主要通过 Redis 来保证消息消费的完整性，注意设置 TTL。
2、枚举表示：-1 表示消息消费异常，1 表示消息正常消费
3. 由于 ons-client 对 consumer 和 producer 没有做优雅关机的自动配置，因此需要我们人为的对其 bean 做 shutdown 处理


3.4 消息丢失
消息丢失的情况极有可能是消息不一致引起的
消息不一致的原因无非三种（逐一排查即可）：
    Group ID 设置错误
    Topic 设置错误
    Tag 设置错误

解决完消息不一致后，接着我们定位到消息不一致发生的时间段，将消息消费点重置到这个时间段开始，进行消息的重新消费

由于我们使用了【3.2消息重复接收】的方案，因此不会出现已经消费的消息被重复消费的情况



更多参考
在 MQVersion 类中可以看到 CURRENT_VERSION 字段是 4.3.6，猜测 ONS 服务端是基于 RocketMQ 4.3.6 版本，因此可以多了解 RocketMQ 4.3.6 版本。
推荐书籍《RocketMQ技术内幕》
B站 RocketMQ 官方视频：https://space.bilibili.com/271666652?from=search&seid=18398985987289994532
ONS 作者讲解 ONS 原理视频：https://v.youku.com/vshow/idXODY4ODE3OTY0.html?from=s1.8-1-1.2
某个读者阅读 RocketMQ 的笔记：https://github.com/LiWenGu/awesome-rocketmq








